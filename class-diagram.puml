@startuml Order Status Tracker - Class Diagram

' Style configurations
skinparam class {
    BackgroundColor White
    ArrowColor Black
    BorderColor Black
}

' Controllers
package "Controller Layer" {
    class OrderController {
        + createOrder(orderDTO: OrderDTO): ResponseEntity
        + getOrderDetails(orderId: Long): ResponseEntity
        + getAllOrders(): ResponseEntity
    }

    class WebhookController {
        + handleWebhook(payload: WebhookPayload): ResponseEntity
    }
}

' Services
package "Service Layer" {
    class OrderService {
        - orderRepository: OrderRepository
        - orderProductTypeRepository: OrderProductTypeRepository
        - itemService: ItemService
        - statusDefinitionRepository: StatusDefinitionRepository
        - productTypeRepository: ProductTypeRepository
        - itemRepository: ItemRepository
        - orderMapper: OrderMapper
        - orderDetailsMapper: OrderDetailsMapper
        + createOrder(orderDTO: OrderDTO): Order
        + getOrderDetails(orderId: Long): List<OrderDetailsWithStatusDTO>
        + getAllOrders(): List<OrderDashboardDTO>
        + createStatusDefinition(dto: StatusDefinitionDTO): StatusDefinition
    }

    class WebhookService {
        - orderService: OrderService
        - itemService: ItemService
        - productTypeService: ProductTypeService
        - itemRepository: ItemRepository
        - productTypeRepository: ProductTypeRepository
        - orderProductTypeRepository: OrderProductTypeRepository
        - webhookMapper: WebhookMapper
        - orderMapper: OrderMapper
        + createOrderInDatabase(payload: WebhookPayload): void
    }

    class ItemService {
        - itemRepository: ItemRepository
        - productTypeRepository: ProductTypeRepository
        + createItem(itemDTO: ItemDTO): Item
        + findById(id: Long): Item
    }

    class ProductTypeService {
        - productTypeRepository: ProductTypeRepository
        - statusDefinitionRepository: StatusDefinitionRepository
        + createProductType(productTypeDTO: ProductTypeDTO): ProductType
        + updateItemProductType(itemId: Long, targetProductTypeId: Long): void
    }

    class OrderProgressService {
        + getProgress(orderDetailsId: Long): OrderProgress
        + moveToNextStep(orderDetailsId: Long): OrderProgress
        + moveToPreviousStep(orderDetailsId: Long): OrderProgress
    }
}

' Mapper Layer
package "Mapper Layer" {
    class OrderMapper {
        + toModelOrder(domainOrder: Order): Order
        + toOrderDTO(order: Order): OrderDTO
    }

    class OrderDetailsMapper {
        - statusDefinitionRepository: StatusDefinitionRepository
        + toOrderDetailsDTO(details: OrderDetails): OrderDetailsWithStatusDTO
        + toOrderDashboardDTO(orderEntity: Order, orderDetails: List<OrderDetails>): OrderDashboardDTO
    }

    class WebhookMapper {
        + toCustomerInfo(payload: WebhookPayload): CustomerInfo
    }
}

' Domain Layer
package "Domain Layer" {
    class Order {
        - id: OrderId
        - customerInfo: CustomerInfo
        - items: Set<OrderItem>
        - timeline: OrderTimeline
        - estimation: OrderEstimation
        - events: List<OrderEvent>
    }

    class OrderFactory {
        + {static} createOrder(id: OrderId, customerInfo: CustomerInfo, items: Map<Long, Integer>, processingTimes: Map<Long, Integer>, priority: boolean): Order
    }

    interface OrderCommand {
        + execute(order: Order): void
    }

    class CreateOrderCommand {
        - id: OrderId
        - customerInfo: CustomerInfo
        - items: Map<Long, Integer>
        - processingTimes: Map<Long, Integer>
        - priority: boolean
        + execute(order: Order): void
    }

    class UpdateItemStatusCommand {
        - itemId: Long
        - newStatus: OrderStatus
        + execute(order: Order): void
    }

    class UpdateProductTypeCommand {
        - itemId: Long
        - transition: ProductTypeTransition
        + execute(order: Order): void
    }

    class CreateItemCommand {
        - itemDTO: ItemDTO
        - itemRepository: ItemRepository
        - productTypeRepository: ProductTypeRepository
        + execute(): Item
    }

    class CreateProductTypeCommand {
        - productTypeDTO: ProductTypeDTO
        - productTypeRepository: ProductTypeRepository
        - statusDefinitionRepository: StatusDefinitionRepository
        + execute(): ProductType
    }

    class CreateStatusDefinitionCommand {
        - dto: StatusDefinitionDTO
        - repository: StatusDefinitionRepository
        + execute(): StatusDefinition
    }

    class ProcessWebhookCommand {
        - payload: WebhookPayload
        - orderService: OrderService
        - itemService: ItemService
        - repositories...
        + execute(): void
    }

    class SetupOrderDetailsCommand {
        - orderId: Long
        - items: Map<Long, Integer>
        - repositories...
        + execute(): void
    }

    interface OrderSpecification {
        + isSatisfiedBy(order: Order): boolean
    }

    class OrderInvariantsSpecification {
        + {static} getInstance(): OrderInvariantsSpecification
        + isSatisfiedBy(order: Order): boolean
    }

    class WebhookOrder {
        + {static} fromPayload(payload: WebhookPayload): WebhookOrder
    }
}

' Model Layer
package "Model Layer" {
    interface OrderRepository {
        + save(order: Order): Order
        + findById(id: Long): Optional<Order>
    }

    interface OrderProductTypeRepository {
        + save(orderDetails: OrderDetails): OrderDetails
        + findByOrderId(orderId: Long): List<OrderDetails>
    }

    interface ItemRepository {
        + save(item: Item): Item
        + findById(id: Long): Optional<Item>
    }

    interface ProductTypeRepository {
        + save(productType: ProductType): ProductType
        + findById(id: Long): Optional<ProductType>
    }

    class OrderEntity {
        - id: Long
        - customerName: String
        - priority: boolean
        - notes: String
    }

    class OrderDetails {
        - id: Long
        - orderId: Long
        - item: Item
        - itemAmount: Integer
        - product_type: String
        - currentStepIndex: Integer
        - differentSteps: Long[]
        - updated: Map<Long, LocalDateTime>
    }
}

' Relationships
OrderController ..> OrderService: uses
WebhookController ..> WebhookService: uses

WebhookService ..> OrderService: delegates order creation
WebhookService ..> WebhookOrder: converts payload
WebhookService ..> ItemService: ensures items exist
WebhookService ..> OrderProductTypeRepository: creates order details
WebhookService ..> WebhookMapper: uses
WebhookService ..> OrderMapper: uses
WebhookService ..> ProcessWebhookCommand: uses

OrderService ..> OrderFactory: creates orders
OrderService ..> OrderInvariantsSpecification: validates
OrderService ..> OrderRepository: persists
OrderService ..> ItemRepository: uses
OrderService ..> ItemService: uses
OrderService ..> ProductTypeService: uses
OrderService ..> OrderProductTypeRepository: creates order details
OrderService ..> OrderMapper: uses
OrderService ..> OrderDetailsMapper: uses
OrderService ..> CreateStatusDefinitionCommand: uses
OrderService ..> SetupOrderDetailsCommand: uses

ItemService ..> CreateItemCommand: uses
ProductTypeService ..> CreateProductTypeCommand: uses
ProductTypeService ..> UpdateProductTypeCommand: uses

OrderCommand <|.. CreateOrderCommand
OrderCommand <|.. UpdateItemStatusCommand
OrderCommand <|.. UpdateProductTypeCommand

OrderFactory ..> Order: creates
WebhookOrder ..> CustomerInfo: creates
WebhookOrder ..> OrderId: creates

UpdateProductTypeCommand ..> ProductTypeTransition: uses
UpdateItemStatusCommand ..> OrderStatus: uses

ProcessWebhookCommand ..> SetupOrderDetailsCommand: uses

OrderMapper ..> Order: maps
OrderDetailsMapper ..> OrderDetails: maps
WebhookMapper ..> CustomerInfo: maps

@enduml
